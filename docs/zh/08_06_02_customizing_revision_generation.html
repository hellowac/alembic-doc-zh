<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>生成自定义修订 - alembic 中文文档</title>
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="../favicon.svg">
                        <link rel="shortcut icon" href="../favicon.png">
                <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
                <link rel="stylesheet" href="../css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="../fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../zh/_front_matter.html">前言</a></li><li class="spacer"></li><li class="chapter-item expanded "><a href="../zh/00_tutorial.html"><strong aria-hidden="true">1.</strong> 指南</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../zh/00_01_the_migration_enviroment.html"><strong aria-hidden="true">1.1.</strong> 迁移环境</a></li><li class="chapter-item "><a href="../zh/00_02_creating_an_enviroment.html"><strong aria-hidden="true">1.2.</strong> 创建环境</a></li><li class="chapter-item "><a href="../zh/00_03_Editing_the_ini_file.html"><strong aria-hidden="true">1.3.</strong> 编辑.ini文件</a></li><li class="chapter-item "><a href="../zh/00_04_create_a_migration_script.html"><strong aria-hidden="true">1.4.</strong> 创建迁移脚本</a></li><li class="chapter-item "><a href="../zh/00_05_Running_our_first_migration.html"><strong aria-hidden="true">1.5.</strong> 初次运行迁移</a></li><li class="chapter-item "><a href="../zh/00_06_Running_our_second_migration.html"><strong aria-hidden="true">1.6.</strong> 再次运行迁移</a></li><li class="chapter-item "><a href="../zh/00_07_partial_revision_identifiers.html"><strong aria-hidden="true">1.7.</strong> 部分修订标识符</a></li><li class="chapter-item "><a href="../zh/00_08_relative_migration_identifiers.html"><strong aria-hidden="true">1.8.</strong> 相对迁移标识符</a></li><li class="chapter-item "><a href="../zh/00_09_getting_information.html"><strong aria-hidden="true">1.9.</strong> 获取信息</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../zh/00_09_01_viewing_history_ranges.html"><strong aria-hidden="true">1.9.1.</strong> 查看历史范围</a></li></ol></li><li class="chapter-item "><a href="../zh/00_10_downgrading.html"><strong aria-hidden="true">1.10.</strong> 降级</a></li><li class="chapter-item "><a href="../zh/00_11_next_steps.html"><strong aria-hidden="true">1.11.</strong> 下一步</a></li></ol></li><li class="chapter-item expanded "><a href="../zh/01_auto_generating_migrations.html"><strong aria-hidden="true">2.</strong> 基于自动生成的迁移</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../zh/01_01_what_does_autogenerate_detect.html"><strong aria-hidden="true">2.1.</strong> Autogenerate 检测什么</a></li><li class="chapter-item "><a href="../zh/01_02_autogenerating_multiple_metadata_collections.html"><strong aria-hidden="true">2.2.</strong> 自动生成多个元数据集合</a></li><li class="chapter-item "><a href="../zh/01_03_controlling_what_to_be_autogenerated.html"><strong aria-hidden="true">2.3.</strong> 控制要自动生成的内容</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../zh/01_03_01_omitting_schema_names_from_the_autogenerate_process.html"><strong aria-hidden="true">2.3.1.</strong> 从自动生成过程中过滤模式名称</a></li><li class="chapter-item "><a href="../zh/01_03_02_omitting_table_names_from_the_autogenerate_process.html"><strong aria-hidden="true">2.3.2.</strong> 从自动生成过程中过滤表名</a></li><li class="chapter-item "><a href="../zh/01_03_03_omitting_based_on_object.html"><strong aria-hidden="true">2.3.3.</strong> 基于对象的过滤</a></li></ol></li><li class="chapter-item "><a href="../zh/01_04_comparing_and_rendering_types.html"><strong aria-hidden="true">2.4.</strong> 比较和渲染类型</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../zh/01_04_01_controlling_the_module_prefix.html"><strong aria-hidden="true">2.4.1.</strong> 控制模块前缀</a></li><li class="chapter-item "><a href="../zh/01_04_02_affecting_the_rendering_of_types_themselves.html"><strong aria-hidden="true">2.4.2.</strong> 影响类型本身的渲染</a></li><li class="chapter-item "><a href="../zh/01_04_03_comparing_types.html"><strong aria-hidden="true">2.4.3.</strong> 比较类型</a></li></ol></li><li class="chapter-item "><a href="../zh/01_05_applying_post_processing.html"><strong aria-hidden="true">2.5.</strong> 将提交处理过程和 Python 代码格式化程序应用于生成的修订</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../zh/01_05_01_basic_formatter_configuration.html"><strong aria-hidden="true">2.5.1.</strong> 基本格式化程序配置</a></li><li class="chapter-item "><a href="../zh/01_05_02_writing_custom_hooks_as_python_functions.html"><strong aria-hidden="true">2.5.2.</strong> 自定义Python函数钩子</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../zh/02_generating_sql_scripts.html"><strong aria-hidden="true">3.</strong> 生成SQL脚本(又称离线模式)</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../zh/02_01_getting_the_start_version.html"><strong aria-hidden="true">3.1.</strong> 获取起始版本</a></li><li class="chapter-item "><a href="../zh/02_02_writing_migration_scripts_to_support_script_generation.html"><strong aria-hidden="true">3.2.</strong> 编写支持生成脚本的迁移脚本</a></li><li class="chapter-item "><a href="../zh/02_03_customizing_the_environment.html"><strong aria-hidden="true">3.3.</strong> 自定义环境</a></li></ol></li><li class="chapter-item expanded "><a href="../zh/03_the_importance_of_naming_constraints.html"><strong aria-hidden="true">4.</strong> 命名约束的重要性</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../zh/03_01_integration_of_naming_conventions_into_operations_autogenerate.html"><strong aria-hidden="true">4.1.</strong> 将命名约定集成到操作中以及自动生成中</a></li></ol></li><li class="chapter-item expanded "><a href="../zh/04_running_batch_migrations_for_sqlite_and_other_databases.html"><strong aria-hidden="true">5.</strong> 在SQLite和其他数据中运行&quot;批处理&quot;迁移脚本</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../zh/04_01_controlling_table_reflection.html"><strong aria-hidden="true">5.1.</strong> 控制表反射</a></li><li class="chapter-item "><a href="../zh/04_02_dealing_with_constraints.html"><strong aria-hidden="true">5.2.</strong> 处理约束</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../zh/04_02_01_dropping_unnamed_or_named_foreign_key_constraints.html"><strong aria-hidden="true">5.2.1.</strong> 删除未命名或命名的外键约束</a></li><li class="chapter-item "><a href="../zh/04_02_02_including_unnamed_unique_constraints.html"><strong aria-hidden="true">5.2.2.</strong> 包含未命名的 UNIQUE 约束</a></li><li class="chapter-item "><a href="../zh/04_02_03_changing_the_type_of_boolean.html"><strong aria-hidden="true">5.2.3.</strong> 更改布尔、枚举和其他隐式 CHECK 数据类型的类型</a></li><li class="chapter-item "><a href="../zh/04_02_04_including_check_constraints.html"><strong aria-hidden="true">5.2.4.</strong> 包括 CHECK 约束</a></li><li class="chapter-item "><a href="../zh/04_02_05_dealing_with_referencing_foreign_keys.html"><strong aria-hidden="true">5.2.5.</strong> 处理引用外键</a></li></ol></li><li class="chapter-item "><a href="../zh/04_03_working_in_offline_mode.html"><strong aria-hidden="true">5.3.</strong> 在离线模式下工作</a></li><li class="chapter-item "><a href="../zh/04_04_batch_mode_with_autogenerate.html"><strong aria-hidden="true">5.4.</strong> 带自动生成的批处理模式</a></li><li class="chapter-item "><a href="../zh/04_05_batch_mode_with_databases_other_than_sqlite.html"><strong aria-hidden="true">5.5.</strong> SQLite 以外的数据库的批处理模式</a></li></ol></li><li class="chapter-item expanded "><a href="../zh/05_working_with_branches.html"><strong aria-hidden="true">6.</strong> 工作分支</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../zh/05_01_merging_branches.html"><strong aria-hidden="true">6.1.</strong> 合并分支</a></li><li class="chapter-item "><a href="../zh/05_02_working_with_explicit_branches.html"><strong aria-hidden="true">6.2.</strong> 使用显式分支</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../zh/05_02_01_referring_to_all_heads_at_once.html"><strong aria-hidden="true">6.2.1.</strong> 一次引用到所有的head</a></li><li class="chapter-item "><a href="../zh/05_02_02_referring_to_a_specific_version.html"><strong aria-hidden="true">6.2.2.</strong> 引用特定版本</a></li><li class="chapter-item "><a href="../zh/05_02_03_working_with_branch_labels.html"><strong aria-hidden="true">6.2.3.</strong> 使用分支标注</a></li><li class="chapter-item "><a href="../zh/05_02_04_more_label_syntaxes.html"><strong aria-hidden="true">6.2.4.</strong> 更多标注语法</a></li></ol></li><li class="chapter-item "><a href="../zh/05_03_working_with_multiple_bases.html"><strong aria-hidden="true">6.3.</strong> 基于多个base工作</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../zh/05_03_01_setting_up_multiple_version_directories.html"><strong aria-hidden="true">6.3.1.</strong> 设置多版本目录</a></li><li class="chapter-item "><a href="../zh/05_03_01_creating_a_labeled_base_revision.html"><strong aria-hidden="true">6.3.2.</strong> 创建带标注的基本修订</a></li><li class="chapter-item "><a href="../zh/05_03_02_running_with_multiple_bases.html"><strong aria-hidden="true">6.3.3.</strong> 基于多个base运行</a></li></ol></li><li class="chapter-item "><a href="../zh/05_04_branch_dependencies.html"><strong aria-hidden="true">6.4.</strong> 分支依赖</a></li></ol></li><li class="chapter-item expanded "><a href="../zh/06_operation_reference.html"><strong aria-hidden="true">7.</strong> 操作参考</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../zh/06_01_operations.html"><strong aria-hidden="true">7.1.</strong> alembic.operations.Operations</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../zh/06_01_01_add_column.html"><strong aria-hidden="true">7.1.1.</strong> add_column</a></li><li class="chapter-item "><a href="../zh/06_01_02_alter_column.html"><strong aria-hidden="true">7.1.2.</strong> alter_column</a></li><li class="chapter-item "><a href="../zh/06_01_03_batch_alter_table.html"><strong aria-hidden="true">7.1.3.</strong> batch_alter_table</a></li><li class="chapter-item "><a href="../zh/06_01_04_bulk_insert.html"><strong aria-hidden="true">7.1.4.</strong> bulk_insert</a></li><li class="chapter-item "><a href="../zh/06_01_05_create_check_constraint.html"><strong aria-hidden="true">7.1.5.</strong> create_check_constraint</a></li><li class="chapter-item "><a href="../zh/06_01_06_create_exclude_constraint.html"><strong aria-hidden="true">7.1.6.</strong> create_exclude_constraint</a></li><li class="chapter-item "><a href="../zh/06_01_07_create_foreign_key.html"><strong aria-hidden="true">7.1.7.</strong> create_foreign_key</a></li><li class="chapter-item "><a href="../zh/06_01_08_create_index.html"><strong aria-hidden="true">7.1.8.</strong> create_index</a></li><li class="chapter-item "><a href="../zh/06_01_09_create_primary_key.html"><strong aria-hidden="true">7.1.9.</strong> create_primary_key</a></li><li class="chapter-item "><a href="../zh/06_01_10_create_table.html"><strong aria-hidden="true">7.1.10.</strong> create_table</a></li><li class="chapter-item "><a href="../zh/06_01_11_create_table_comment.html"><strong aria-hidden="true">7.1.11.</strong> create_table_comment</a></li><li class="chapter-item "><a href="../zh/06_01_12_create_unique_constraint.html"><strong aria-hidden="true">7.1.12.</strong> create_unique_constraint</a></li><li class="chapter-item "><a href="../zh/06_01_13_drop_column.html"><strong aria-hidden="true">7.1.13.</strong> drop_column</a></li><li class="chapter-item "><a href="../zh/06_01_14_drop_constraint.html"><strong aria-hidden="true">7.1.14.</strong> drop_constraint</a></li><li class="chapter-item "><a href="../zh/06_01_15_drop_index.html"><strong aria-hidden="true">7.1.15.</strong> drop_index</a></li><li class="chapter-item "><a href="../zh/06_01_16_drop_table.html"><strong aria-hidden="true">7.1.16.</strong> drop_table</a></li><li class="chapter-item "><a href="../zh/06_01_17_drop_table_comment.html"><strong aria-hidden="true">7.1.17.</strong> drop_table_comment</a></li><li class="chapter-item "><a href="../zh/06_01_18_execute.html"><strong aria-hidden="true">7.1.18.</strong> execute</a></li><li class="chapter-item "><a href="../zh/06_01_19_f.html"><strong aria-hidden="true">7.1.19.</strong> f</a></li><li class="chapter-item "><a href="../zh/06_01_20_get_bind.html"><strong aria-hidden="true">7.1.20.</strong> get_bind</a></li><li class="chapter-item "><a href="../zh/06_01_21_get_context.html"><strong aria-hidden="true">7.1.21.</strong> get_context</a></li><li class="chapter-item "><a href="../zh/06_01_22_implementation_for.html"><strong aria-hidden="true">7.1.22.</strong> implementation_for</a></li><li class="chapter-item "><a href="../zh/06_01_23_inline_literal.html"><strong aria-hidden="true">7.1.23.</strong> inline_literal</a></li><li class="chapter-item "><a href="../zh/06_01_24_invoke.html"><strong aria-hidden="true">7.1.24.</strong> invoke</a></li><li class="chapter-item "><a href="../zh/06_01_25_register_operation.html"><strong aria-hidden="true">7.1.25.</strong> register_operation</a></li><li class="chapter-item "><a href="../zh/06_01_26_rename_table.html"><strong aria-hidden="true">7.1.26.</strong> rename_table</a></li></ol></li><li class="chapter-item "><a href="../zh/06_02_batch_operations.html"><strong aria-hidden="true">7.2.</strong> alembic.operations.BatchOperations</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../zh/06_02_01_add_column.html"><strong aria-hidden="true">7.2.1.</strong> add_column</a></li><li class="chapter-item "><a href="../zh/06_02_02_alter_column.html"><strong aria-hidden="true">7.2.2.</strong> alter_column</a></li><li class="chapter-item "><a href="../zh/06_02_03_create_check_constraint.html"><strong aria-hidden="true">7.2.3.</strong> create_check_constraint</a></li><li class="chapter-item "><a href="../zh/06_02_04_create_exclude_constraint.html"><strong aria-hidden="true">7.2.4.</strong> create_exclude_constraint</a></li><li class="chapter-item "><a href="../zh/06_02_05_create_foreign_key.html"><strong aria-hidden="true">7.2.5.</strong> create_foreign_key</a></li><li class="chapter-item "><a href="../zh/06_02_06_create_index.html"><strong aria-hidden="true">7.2.6.</strong> create_index</a></li><li class="chapter-item "><a href="../zh/06_02_07_create_primary_key.html"><strong aria-hidden="true">7.2.7.</strong> create_primary_key</a></li><li class="chapter-item "><a href="../zh/06_02_08_create_table_comment.html"><strong aria-hidden="true">7.2.8.</strong> create_table_comment</a></li><li class="chapter-item "><a href="../zh/06_02_09_create_unique_constraint.html"><strong aria-hidden="true">7.2.9.</strong> create_unique_constraint</a></li><li class="chapter-item "><a href="../zh/06_02_10_drop_column.html"><strong aria-hidden="true">7.2.10.</strong> drop_column</a></li><li class="chapter-item "><a href="../zh/06_02_11_drop_constraint.html"><strong aria-hidden="true">7.2.11.</strong> drop_constraint</a></li><li class="chapter-item "><a href="../zh/06_02_12_drop_index.html"><strong aria-hidden="true">7.2.12.</strong> drop_index</a></li><li class="chapter-item "><a href="../zh/06_02_13_drop_table_comment.html"><strong aria-hidden="true">7.2.13.</strong> drop_table_comment</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../zh/07_cook_book.html"><strong aria-hidden="true">8.</strong> cookbook</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../zh/07_01_building_an_up_to_date_database_from_scratch.html"><strong aria-hidden="true">8.1.</strong> 从头开始构建最新的数据库</a></li><li class="chapter-item "><a href="../zh/07_02_conditional_migration_elements.html"><strong aria-hidden="true">8.2.</strong> 条件迁移元素</a></li><li class="chapter-item "><a href="../zh/07_03_sharing_a_connection_with_a_series_of_migration_commands_and_environments.html"><strong aria-hidden="true">8.3.</strong> 与一系列迁移命令和环境共享连接</a></li><li class="chapter-item "><a href="../zh/07_04_replaceable_objects.html"><strong aria-hidden="true">8.4.</strong> 可替换对象</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../zh/07_04_01_the_replaceable_object_structure.html"><strong aria-hidden="true">8.4.1.</strong> 可替换对象结构</a></li><li class="chapter-item "><a href="../zh/07_04_02_create_operations_for_the_target_objects.html"><strong aria-hidden="true">8.4.2.</strong> 为目标对象创建操作</a></li><li class="chapter-item "><a href="../zh/07_04_03_create_initial_migrations.html"><strong aria-hidden="true">8.4.3.</strong> 创建初始迁移</a></li><li class="chapter-item "><a href="../zh/07_04_04_create_revision_migrations.html"><strong aria-hidden="true">8.4.4.</strong> 创建修订迁移</a></li></ol></li><li class="chapter-item "><a href="../zh/07_05_rudimental_schema_level_multi_tenancy_for_postgresql_databases.html"><strong aria-hidden="true">8.5.</strong> PostgreSQL 数据库的基础架构级多租户</a></li><li class="chapter-item "><a href="../zh/07_06_dont_generate_empty_migrations_with_autogenerate.html"><strong aria-hidden="true">8.6.</strong> 不要使用 Autogenerate 生成空迁移</a></li><li class="chapter-item "><a href="../zh/07_07_dont_emit_drop_index_when_the_table_is_to_be_dropped_as_well.html"><strong aria-hidden="true">8.7.</strong> 当表也将被删除时不要发出 DROP INDEX</a></li><li class="chapter-item "><a href="../zh/07_08_dont_generate_any_drop_table_directives_with_autogenerate.html"><strong aria-hidden="true">8.8.</strong> 不要使用autogenerate生成任何 DROP TABLE 指令</a></li><li class="chapter-item "><a href="../zh/07_09_apply_custom_sorting_to_table_columns_within_create_table.html"><strong aria-hidden="true">8.9.</strong> 将自定义排序应用于 CREATE TABLE 中的表列</a></li><li class="chapter-item "><a href="../zh/07_10_dont_emit_create_table_statements_for_views.html"><strong aria-hidden="true">8.10.</strong> 不要为视图发出 CREATE TABLE 语句</a></li><li class="chapter-item "><a href="../zh/07_11_run_multiple_alembic_environments_from_one_ini_file.html"><strong aria-hidden="true">8.11.</strong> 从一个 .ini 文件运行多个 Alembic 环境</a></li><li class="chapter-item "><a href="../zh/07_12_print_python_code_to_generate_particular_database_tables.html"><strong aria-hidden="true">8.12.</strong> 打印 Python 代码以生成特定的数据库表</a></li><li class="chapter-item "><a href="../zh/07_13_run_alembic_operation_objects_directly_as_in_from_autogenerate.html"><strong aria-hidden="true">8.13.</strong> 直接运行 Alembic 操作对象（如来自autogenerate）</a></li><li class="chapter-item "><a href="../zh/07_14_test_current_database_revision_is_at_heads.html"><strong aria-hidden="true">8.14.</strong> 测试当前的数据库修订版本处于head</a></li><li class="chapter-item "><a href="../zh/07_15_using_asyncio_with_alembic.html"><strong aria-hidden="true">8.15.</strong> 将 Asyncio 与 Alembic 结合使用</a></li></ol></li><li class="chapter-item expanded "><a href="../zh/08_api_details.html"><strong aria-hidden="true">9.</strong> API详细</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../zh/08_01_overview.html"><strong aria-hidden="true">9.1.</strong> 概览</a></li><li class="chapter-item "><a href="../zh/08_02_runtime_objects.html"><strong aria-hidden="true">9.2.</strong> 运行时对象</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../zh/08_02_01_the_environment_context.html"><strong aria-hidden="true">9.2.1.</strong> Environment Context</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../zh/08_02_01_01_begin_transaction.html"><strong aria-hidden="true">9.2.1.1.</strong> begin_transaction</a></li><li class="chapter-item "><a href="../zh/08_02_01_16_config.html"><strong aria-hidden="true">9.2.1.2.</strong> config</a></li><li class="chapter-item "><a href="../zh/08_02_01_02_configure.html"><strong aria-hidden="true">9.2.1.3.</strong> configure</a></li><li class="chapter-item "><a href="../zh/08_02_01_03_execute.html"><strong aria-hidden="true">9.2.1.4.</strong> execute</a></li><li class="chapter-item "><a href="../zh/08_02_01_04_get_bind.html"><strong aria-hidden="true">9.2.1.5.</strong> get_bind</a></li><li class="chapter-item "><a href="../zh/08_02_01_05_get_context.html"><strong aria-hidden="true">9.2.1.6.</strong> get_context</a></li><li class="chapter-item "><a href="../zh/08_02_01_06_get_head_revision.html"><strong aria-hidden="true">9.2.1.7.</strong> get_head_revision</a></li><li class="chapter-item "><a href="../zh/08_02_01_07_get_head_revisions.html"><strong aria-hidden="true">9.2.1.8.</strong> get_head_revisions</a></li><li class="chapter-item "><a href="../zh/08_02_01_08_get_revision_argument.html"><strong aria-hidden="true">9.2.1.9.</strong> get_revision_argument</a></li><li class="chapter-item "><a href="../zh/08_02_01_09_get_starting_revision_argument.html"><strong aria-hidden="true">9.2.1.10.</strong> get_starting_revision_argument</a></li><li class="chapter-item "><a href="../zh/08_02_01_10_get_tag_argument.html"><strong aria-hidden="true">9.2.1.11.</strong> get_tag_argument</a></li><li class="chapter-item "><a href="../zh/08_02_01_11_get_x_argument.html"><strong aria-hidden="true">9.2.1.12.</strong> get_x_argument</a></li><li class="chapter-item "><a href="../zh/08_02_01_12_is_offline_mode.html"><strong aria-hidden="true">9.2.1.13.</strong> is_offline_mode</a></li><li class="chapter-item "><a href="../zh/08_02_01_13_is_transactional_ddl.html"><strong aria-hidden="true">9.2.1.14.</strong> is_transactional_ddl</a></li><li class="chapter-item "><a href="../zh/08_02_01_14_run_migrations.html"><strong aria-hidden="true">9.2.1.15.</strong> run_migrations</a></li><li class="chapter-item "><a href="../zh/08_02_01_17_script.html"><strong aria-hidden="true">9.2.1.16.</strong> script</a></li><li class="chapter-item "><a href="../zh/08_02_01_15_static_output.html"><strong aria-hidden="true">9.2.1.17.</strong> static_output</a></li></ol></li><li class="chapter-item "><a href="../zh/08_02_02_the_migration_context.html"><strong aria-hidden="true">9.2.2.</strong> Migration Context</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../zh/08_02_02_01_autocommit_block.html"><strong aria-hidden="true">9.2.2.1.</strong> autocommit_block</a></li><li class="chapter-item "><a href="../zh/08_02_02_02_begin_transaction.html"><strong aria-hidden="true">9.2.2.2.</strong> begin_transaction</a></li><li class="chapter-item "><a href="../zh/08_02_02_09_bind.html"><strong aria-hidden="true">9.2.2.3.</strong> bind</a></li><li class="chapter-item "><a href="../zh/08_02_02_10_config.html"><strong aria-hidden="true">9.2.2.4.</strong> config</a></li><li class="chapter-item "><a href="../zh/08_02_02_03_configure.html"><strong aria-hidden="true">9.2.2.5.</strong> configure</a></li><li class="chapter-item "><a href="../zh/08_02_02_04_execute.html"><strong aria-hidden="true">9.2.2.6.</strong> execute</a></li><li class="chapter-item "><a href="../zh/08_02_02_05_get_current_heads.html"><strong aria-hidden="true">9.2.2.7.</strong> get_current_heads</a></li><li class="chapter-item "><a href="../zh/08_02_02_06_get_current_revision.html"><strong aria-hidden="true">9.2.2.8.</strong> get_current_revision</a></li><li class="chapter-item "><a href="../zh/08_02_02_07_run_migrations.html"><strong aria-hidden="true">9.2.2.9.</strong> run_migrations</a></li><li class="chapter-item "><a href="../zh/08_02_02_08_stamp.html"><strong aria-hidden="true">9.2.2.10.</strong> stamp</a></li></ol></li></ol></li><li class="chapter-item "><a href="../zh/08_03_configuration.html"><strong aria-hidden="true">9.3.</strong> 配置</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../zh/08_03_01_attributes.html"><strong aria-hidden="true">9.3.1.</strong> attributes</a></li><li class="chapter-item "><a href="../zh/08_03_02_cmd_opts.html"><strong aria-hidden="true">9.3.2.</strong> cmd_opts</a></li><li class="chapter-item "><a href="../zh/08_03_03_config_file_name.html"><strong aria-hidden="true">9.3.3.</strong> config_file_name</a></li><li class="chapter-item "><a href="../zh/08_03_04_config_ini_section.html"><strong aria-hidden="true">9.3.4.</strong> config_ini_section</a></li><li class="chapter-item "><a href="../zh/08_03_05_file_config.html"><strong aria-hidden="true">9.3.5.</strong> file_config</a></li><li class="chapter-item "><a href="../zh/08_03_06_get_main_option.html"><strong aria-hidden="true">9.3.6.</strong> get_main_option</a></li><li class="chapter-item "><a href="../zh/08_03_07_get_section.html"><strong aria-hidden="true">9.3.7.</strong> get_section</a></li><li class="chapter-item "><a href="../zh/08_03_08_get_section_option.html"><strong aria-hidden="true">9.3.8.</strong> get_section_option</a></li><li class="chapter-item "><a href="../zh/08_03_09_get_template_directory.html"><strong aria-hidden="true">9.3.9.</strong> get_template_directory</a></li><li class="chapter-item "><a href="../zh/08_03_10_print_stdout.html"><strong aria-hidden="true">9.3.10.</strong> print_stdout</a></li><li class="chapter-item "><a href="../zh/08_03_11_set_main_option.html"><strong aria-hidden="true">9.3.11.</strong> set_main_option</a></li><li class="chapter-item "><a href="../zh/08_03_12_set_section_option.html"><strong aria-hidden="true">9.3.12.</strong> set_section_option</a></li><li class="chapter-item "><a href="../zh/08_03_13_main.html"><strong aria-hidden="true">9.3.13.</strong> main</a></li></ol></li><li class="chapter-item "><a href="../zh/08_04_commands.html"><strong aria-hidden="true">9.4.</strong> 命令</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../zh/08_04_01_branches.html"><strong aria-hidden="true">9.4.1.</strong> branches</a></li><li class="chapter-item "><a href="../zh/08_04_02_current.html"><strong aria-hidden="true">9.4.2.</strong> current</a></li><li class="chapter-item "><a href="../zh/08_04_03_downgrade.html"><strong aria-hidden="true">9.4.3.</strong> downgrade</a></li><li class="chapter-item "><a href="../zh/08_04_04_edit.html"><strong aria-hidden="true">9.4.4.</strong> edit</a></li><li class="chapter-item "><a href="../zh/08_04_05_ensure_version.html"><strong aria-hidden="true">9.4.5.</strong> ensure_version</a></li><li class="chapter-item "><a href="../zh/08_04_06_heads.html"><strong aria-hidden="true">9.4.6.</strong> heads</a></li><li class="chapter-item "><a href="../zh/08_04_07_history.html"><strong aria-hidden="true">9.4.7.</strong> history</a></li><li class="chapter-item "><a href="../zh/08_04_08_init.html"><strong aria-hidden="true">9.4.8.</strong> init</a></li><li class="chapter-item "><a href="../zh/08_04_09_list_templates.html"><strong aria-hidden="true">9.4.9.</strong> list_templates</a></li><li class="chapter-item "><a href="../zh/08_04_10_merge.html"><strong aria-hidden="true">9.4.10.</strong> merge</a></li><li class="chapter-item "><a href="../zh/08_04_11_revision.html"><strong aria-hidden="true">9.4.11.</strong> revision</a></li><li class="chapter-item "><a href="../zh/08_04_12_show.html"><strong aria-hidden="true">9.4.12.</strong> show</a></li><li class="chapter-item "><a href="../zh/08_04_13_stamp.html"><strong aria-hidden="true">9.4.13.</strong> stamp</a></li><li class="chapter-item "><a href="../zh/08_04_14_upgrade.html"><strong aria-hidden="true">9.4.14.</strong> upgrade</a></li></ol></li><li class="chapter-item "><a href="../zh/08_05_operation_directives.html"><strong aria-hidden="true">9.5.</strong> 操作指令</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../zh/08_05_01_operation_plugins.html"><strong aria-hidden="true">9.5.1.</strong> 操作插件</a></li><li class="chapter-item "><a href="../zh/08_05_02_built_in_operation_objects.html"><strong aria-hidden="true">9.5.2.</strong> 内置操作对象</a></li></ol></li><li class="chapter-item expanded "><a href="../zh/08_06_autogeneration.html"><strong aria-hidden="true">9.6.</strong> 自动生成</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../zh/08_06_01_getting_diffs.html"><strong aria-hidden="true">9.6.1.</strong> 获取差异</a></li><li class="chapter-item expanded "><a href="../zh/08_06_02_customizing_revision_generation.html" class="active"><strong aria-hidden="true">9.6.2.</strong> 生成自定义修订</a></li><li class="chapter-item "><a href="../zh/08_06_03_autogenerating_custom_operation_directives.html"><strong aria-hidden="true">9.6.3.</strong> Autogenerate自定义操作指令</a></li></ol></li><li class="chapter-item "><a href="../zh/08_07_script_directory.html"><strong aria-hidden="true">9.7.</strong> 脚本目录</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../zh/08_07_01_revision.html"><strong aria-hidden="true">9.7.1.</strong> 修订</a></li><li class="chapter-item "><a href="../zh/08_07_02_write_hooks.html"><strong aria-hidden="true">9.7.2.</strong> 写钩子</a></li></ol></li><li class="chapter-item "><a href="../zh/08_08_ddl_internals.html"><strong aria-hidden="true">9.8.</strong> DDL 内部结构</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../zh/08_08_01_mysql.html"><strong aria-hidden="true">9.8.1.</strong> MySQL</a></li><li class="chapter-item "><a href="../zh/08_08_02_ms_sql.html"><strong aria-hidden="true">9.8.2.</strong> MS-SQL</a></li><li class="chapter-item "><a href="../zh/08_08_03_postgresql.html"><strong aria-hidden="true">9.8.3.</strong> Postgresql</a></li><li class="chapter-item "><a href="../zh/08_08_04_sqlite.html"><strong aria-hidden="true">9.8.4.</strong> SQLite</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../zh/09_change_log.html"><strong aria-hidden="true">10.</strong> 更新历史</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><a href="../en/genindex.html">index</a></li><li class="chapter-item expanded affix "><a href="../en/py-modindex.html">module-index</a></li><li class="chapter-item expanded affix "><a href="../en/index.html">Document-English</a></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">alembic 中文文档</h1>

                    <div class="right-buttons">
                                                <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="customizing-revision-generation"><a class="header" href="#customizing-revision-generation">Customizing Revision Generation</a></h1>
<p>自定义修订生成</p>
<p><code>alembic revision</code> 命令，也可以通过 <strong><a href="../en/commands.html#alembic.command.revision">command.revision()</a></strong> 以编程方式使用，在运行后本质上会生成一个迁移脚本。 是否指定了 <code>--autogenerate</code> 选项基本上决定了该脚本是具有空的 <code>upgrade()</code> 和 <code>downgrade()</code> 函数的空白修订脚本，还是使用 alembic 操作指令作为自动生成的结果生成的。</p>
<p>在任何一种情况下，系统都会以 <strong><a href="../en/operations.html#alembic.operations.ops.MigrateOperation">MigrateOperation</a></strong> 结构的形式创建一个完整的计划，然后用于生成脚本。</p>
<p>例如，假设我们运行了<code>alembic revision --autogenerate</code>，最终结果是它生成了一个新的修订版<code>'eced083f5df'</code>，其内容如下：</p>
<pre><code class="language-python">&quot;&quot;&quot;create the organization table.&quot;&quot;&quot;

# revision identifiers, used by Alembic.
revision = 'eced083f5df'
down_revision = 'beafc7d709f'

from alembic import op
import sqlalchemy as sa


def upgrade():
    op.create_table(
        'organization',
        sa.Column('id', sa.Integer(), primary_key=True),
        sa.Column('name', sa.String(50), nullable=False)
    )
    op.add_column(
        'user',
        sa.Column('organization_id', sa.Integer())
    )
    op.create_foreign_key(
        'org_fk', 'user', 'organization', ['organization_id'], ['id']
    )

def downgrade():
    op.drop_constraint('org_fk', 'user')
    op.drop_column('user', 'organization_id')
    op.drop_table('organization')
</code></pre>
<p>上面的脚本由一个 <strong><a href="../en/operations.html#alembic.operations.ops.MigrateOperation">MigrateOperation</a></strong> 结构生成，如下所示：</p>
<pre><code class="language-python">from alembic.operations import ops
import sqlalchemy as sa

migration_script = ops.MigrationScript(
    'eced083f5df',
    ops.UpgradeOps(
        ops=[
            ops.CreateTableOp(
                'organization',
                [
                    sa.Column('id', sa.Integer(), primary_key=True),
                    sa.Column('name', sa.String(50), nullable=False)
                ]
            ),
            ops.ModifyTableOps(
                'user',
                ops=[
                    ops.AddColumnOp(
                        'user',
                        sa.Column('organization_id', sa.Integer())
                    ),
                    ops.CreateForeignKeyOp(
                        'org_fk', 'user', 'organization',
                        ['organization_id'], ['id']
                    )
                ]
            )
        ]
    ),
    ops.DowngradeOps(
        ops=[
            ops.ModifyTableOps(
                'user',
                ops=[
                    ops.DropConstraintOp('org_fk', 'user'),
                    ops.DropColumnOp('user', 'organization_id')
                ]
            ),
            ops.DropTableOp('organization')
        ]
    ),
    message='create the organization table.'
)
</code></pre>
<p>当我们处理 <strong><a href="../en/operations.html#alembic.operations.ops.MigrationScript">MigrationScript</a></strong> 结构时，我们可以使用 <strong><a href="#render_python_code">render_python_code()</a></strong> 辅助函数将 <code>upgrade/downgrade</code> 部分渲染为字符串以进行调试：</p>
<pre><code class="language-python">from alembic.autogenerate import render_python_code
print(render_python_code(migration_script.upgrade_ops))
</code></pre>
<p>渲染为:</p>
<pre><code class="language-python">### commands auto generated by Alembic - please adjust! ###
    op.create_table('organization',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(length=50), nullable=False),
    sa.PrimaryKeyConstraint('id')
    )
    op.add_column('user', sa.Column('organization_id', sa.Integer(), nullable=True))
    op.create_foreign_key('org_fk', 'user', 'organization', ['organization_id'], ['id'])
    ### end Alembic commands ###
</code></pre>
<p>鉴于上述结构用于生成新的修订文件，并且我们希望能够在创建这些文件时对其进行更改，因此我们需要一个系统来访问此结构，当 <code>[command.revision()]</code> 命令被使用时,  <code>[EnvironmentContext.configure.process_revision_directives]</code> 参数为我们提供了一种改变它的方法。 这是一个通过 Alembic 生成的上述结构传递的函数，让我们有机会改变它。 例如，如果我们想将所有 “upgrade” 操作放到某个分支中，并且我们希望我们的脚本根本没有任何 “downgrade” 操作，我们可以构建一个扩展，如下所示，在 <code>env.py</code>脚本：</p>
<pre><code class="language-python">def process_revision_directives(context, revision, directives):
    script = directives[0]

    # set specific branch
    script.head = &quot;mybranch@head&quot;

    # erase downgrade operations
    script.downgrade_ops.ops[:] = []

# ...

def run_migrations_online():

    # ...
    with engine.connect() as connection:

        context.configure(
            connection=connection,
            target_metadata=target_metadata,
            process_revision_directives=process_revision_directives)

        with context.begin_transaction():
            context.run_migrations()
</code></pre>
<p>上面，<code>directives</code> 参数是一个 Python 列表。 我们可以就地更改此列表中的给定结构，或将其替换为由零个或多个 <strong><a href="../en/operations.html#alembic.operations.ops.MigrationScript">MigrationScript</a></strong> <code>directives</code> 组成的新结构。 然后 <strong><a href="../en/commands.html#alembic.command.revision">command.revision()</a></strong> 命令将生成与此列表中的任何内容相对应的脚本。</p>
<blockquote>
<p><strong>同样参考:</strong> 更多关于使用 <a href="../en/runtime.html#alembic.runtime.environment.EnvironmentContext.configure.params.process_revision_directives">EnvironmentContext.configure.process_revision_directives</a> 的样例</p>
<ul>
<li><strong><a href="../en/../cookbook.html#cookbook-no-empty-migrations">Don’t Generate Empty Migrations with Autogenerate</a></strong></li>
<li><strong><a href="../en/../cookbook.html#cookbook-dont-emit-drop-index">Don’t emit DROP INDEX when the table is to be dropped as well</a></strong></li>
<li><strong><a href="../en/../cookbook.html#cookbook-custom-sorting-create-table">Apply Custom Sorting to Table Columns within CREATE TABLE</a></strong></li>
</ul>
</blockquote>
<ul>
<li>
<p>alembic.autogenerate.<strong>render_python_code</strong>(<em>up_or_down_op</em>:  UpgradeOps, <em>sqlalchemy_module_prefix</em>:  <a href="https://docs.python.org/3/library/stdtypes.html#str">str</a> = 'sa.', <em>alembic_module_prefix</em>:  <a href="https://docs.python.org/3/library/stdtypes.html#str">str</a> = 'op.', <em>render_as_batch</em>:  <a href="https://docs.python.org/3/library/functions.html#bool">bool</a> = False, <em>imports</em>:  Tuple[<a href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, ...] = (), <em>render_item</em>:  <a href="https://docs.python.org/3/library/constants.html#None">None</a> = <a href="https://docs.python.org/3/library/constants.html#None">None</a>, <em>migration_context</em>:  Optional[MigrationContext] = None) → str <a name="render_python_code"></a></p>
<p>在给定 <strong><a href="../en/operations.html#alembic.operations.ops.UpgradeOps">UpgradeOps</a></strong> 或 <strong><a href="../en/operations.html#alembic.operations.ops.DowngradeOps">DowngradeOps</a></strong> 对象的情况下渲染 Python 代码。</p>
<p>这是一个方便的函数，可用于测试用户定义的 <strong><a href="../en/operations.html#alembic.operations.ops.MigrationScript">MigrationScript</a></strong> 结构的自动生成输出。</p>
</li>
</ul>
<h2 id="fine-grained-autogenerate-generation-with-rewriters"><a class="header" href="#fine-grained-autogenerate-generation-with-rewriters">Fine-Grained Autogenerate Generation with Rewriters</a></h2>
<p><strong>带有重写器的细粒度自动生成</strong></p>
<p>前面的示例说明了我们如何对操作指令的结构进行简单的更改以生成新的自动生成输出。 对于我们想要影响自动生成流的非常特定部分的情况，我们可以为 <strong><a href="../en/runtime.html#alembic.runtime.environment.EnvironmentContext.configure.params.process_revision_directives">EnvironmentContext.configure.process_revision_directives</a></strong> 创建一个函数，该函数遍历整个 <strong><a href="../en/operations.html#alembic.operations.ops.MigrationScript">MigrationScript</a></strong> 结构，定位我们关心的元素并根据需要就地修改它们。 但是，为了减少与此任务相关的样板，我们可以使用 <strong><a href="#alembic.autogenerate.rewriter.Rewriter">Rewriter</a></strong> 对象来简化此操作。 <strong><a href="#alembic.autogenerate.rewriter.Rewriter">Rewriter</a></strong> 为我们提供了一个可以直接传递给 <strong><a href="../en/runtime.html#alembic.runtime.environment.EnvironmentContext.configure.params.process_revision_directives">EnvironmentContext.configure.process_revision_directives</a></strong> 的对象，我们还可以将处理程序函数附加到该对象上，以特定类型为键值。</p>
<p>下面是我们重写 <strong><a href="../en/operations.html#alembic.operations.ops.AddColumnOp">ops.AddColumnOp</a></strong> 指令的示例； 根据新列是否为“可空”，我们要么返回现有指令，要么返回现有指令并更改可空标志，在带有第二个指令的列表内，以在第二步中更改可空标志：</p>
<pre><code class="language-python"># ... fragmented env.py script ....

from alembic.autogenerate import rewriter
from alembic.operations import ops

writer = rewriter.Rewriter()

@writer.rewrites(ops.AddColumnOp)
def add_column(context, revision, op):
    if op.column.nullable:
        return op
    else:
        op.column.nullable = True
        return [
            op,
            ops.AlterColumnOp(
                op.table_name,
                op.column.name,
                modify_nullable=False,
                existing_type=op.column.type,
            )
        ]

# ... later ...

def run_migrations_online():
    # ...

    with connectable.connect() as connection:
        context.configure(
            connection=connection,
            target_metadata=target_metadata,
            process_revision_directives=writer
        )

        with context.begin_transaction():
            context.run_migrations()
</code></pre>
<p>上面，在完整的 <strong><a href="../en/operations.html#alembic.operations.ops.MigrationScript">ops.MigrationScript</a></strong> 结构中，<strong><a href="../en/ddl.html#alembic.ddl.base.AddColumn">AddColumn</a></strong> 指令将出现在 <code>MigrationScript-&gt;UpgradeOps-&gt;ModifyTableOps</code> 和 <code>MigrationScript-&gt;DowngradeOps-&gt;ModifyTableOps</code> 路径中 . <strong><a href="#alembic.autogenerate.rewriter.Rewriter">Rewriter</a></strong> 处理遍历这些结构以及根据需要重写它们，以便我们只需要为我们关心的特定对象编写代码。</p>
<ul>
<li>
<p><em>class</em> alembic.autogenerate.rewriter.<strong>Rewriter</strong></p>
<p>一个帮助对象，允许轻松 ‘rewriting’ 操作流。</p>
<p><strong><a href="#alembic.autogenerate.rewriter.Rewriter">Rewriter</a></strong> 对象旨在传递给 <code>env.py</code> 脚本中的 <strong><a href="../en/runtime.html#alembic.runtime.environment.EnvironmentContext.configure.params.process_revision_directives">EnvironmentContext.configure.process_revision_directives</a></strong> 参数。 一旦构建，任何数量的“重写”函数都可以与之关联，这将有机会修改结构，而无需明确了解整体结构。</p>
<p>该函数传递了通常传递给<code>Environment Context.configure.process_revision_directives</code>函数的**<a href="../en/runtime.html#alembic.runtime.migration.MigrationContext">MigrationContext</a>**对象和<code>revision</code>元组，第三个参数是装饰器中注明的类型的单个指令。 该函数可以选择返回单个操作指令，通常可以是实际传递的指令，或者替换它的新指令，或者替换它的零个或多个指令列表。</p>
<blockquote>
<p><strong>同样参考:</strong> [Fine-Grained Autogenerate Generation with Rewriters - usage example]</p>
</blockquote>
<ul>
<li>
<p><strong>chain</strong>(other: [alembic.autogenerate.rewriter.Rewriter]) → [alembic.autogenerate.rewriter.Rewriter]</p>
<p>生成一个 <strong><a href="#alembic.autogenerate.rewriter.Rewriter">Rewriter</a></strong> 到另一个的 “chain”。</p>
<p>这允许两个重写器在一个流上串行操作，例如：</p>
<pre><code class="language-python">writer1 = autogenerate.Rewriter()
writer2 = autogenerate.Rewriter()

@writer1.rewrites(ops.AddColumnOp)
def add_column_nullable(context, revision, op):
    op.column.nullable = True
    return op

@writer2.rewrites(ops.AddColumnOp)
def add_column_idx(context, revision, op):
    idx_op = ops.CreateIndexOp(
        'ixc', op.table_name, [op.column.name])
    return [
        op,
        idx_op
    ]

writer = writer1.chain(writer2)
</code></pre>
<p><strong>Parameters:</strong> <em><strong>other</strong></em> – 一个 <strong><a href="#alembic.autogenerate.rewriter.Rewriter">Rewriter</a></strong> 实例</p>
<p><strong>Returns:</strong> 一个新的 <strong><a href="#alembic.autogenerate.rewriter.Rewriter">Rewriter</a></strong> 将依次运行这个 writer 的操作，然后是 “other” writer。</p>
</li>
<li>
<p><strong>rewrites</strong>(operator: Union[Type[AddColumnOp], Type[MigrateOperation], Type[AlterColumnOp], Type[CreateTableOp], Type[ModifyTableOps]]) → Callable</p>
<p>将函数注册为给定类型的重写器。</p>
<p>该函数应该接收三个参数，它们是 <strong><a href="../en/runtime.html#alembic.runtime.migration.MigrationContext">MigrationContext</a></strong>、一个 <code>revision</code> 元组和一个指定类型的 op 指令。 例如。：</p>
<pre><code class="language-python">@writer1.rewrites(ops.AddColumnOp)
def add_column_nullable(context, revision, op):
    op.column.nullable = True
    return op
</code></pre>
</li>
</ul>
</li>
</ul>
<h2 id="revision-generation-with-multiple-engines--run_migrations-calls"><a class="header" href="#revision-generation-with-multiple-engines--run_migrations-calls">Revision Generation with Multiple Engines / run_migrations() calls</a></h2>
<p>提供的“multidb”模板中说明了一种较少使用的技术，它允许自动生成的迁移同时针对多个数据库后端运行，将更改生成到单个迁移脚本中。 此模板具有一个特殊的 <code>env.py</code>，它遍历多个 <strong><a href="https://docs.sqlalchemy.org/en/14/core/connections.html#sqlalchemy.engine.Engine">Engine</a></strong> 实例并为每个实例调用 <strong><a href="../en/runtime.html#alembic.runtime.migration.MigrationContext.run_migrations">MigrationContext.run_migrations()</a></strong>：</p>
<pre><code class="language-python">for name, rec in engines.items():
    logger.info(&quot;Migrating database %s&quot; % name)
    context.configure(
        connection=rec['connection'],
        upgrade_token=&quot;%s_upgrades&quot; % name,
        downgrade_token=&quot;%s_downgrades&quot; % name,
        target_metadata=target_metadata.get(name)
    )
    context.run_migrations(engine_name=name)
</code></pre>
<p>如上所示，<strong><a href="../en/runtime.html#alembic.runtime.migration.MigrationContext.run_migrations">MigrationContext.run_migrations()</a></strong> 运行多次，每个引擎运行一次。 在自动生成的上下文中，每次调用方法时都会更改 <strong><a href="../en/runtime.html#alembic.runtime.environment.EnvironmentContext.configure.params.upgrade_token">upgrade_token</a></strong> 和 <strong><a href="../en/runtime.html#alembic.runtime.environment.EnvironmentContext.configure.params.downgrade_token">downgrade_token</a></strong> 参数，以便模板变量的集合为每个引擎获得不同的条目，然后引用 在 <code>script.py.mako</code> 中明确显示。</p>
<p>就 <strong><a href="../en/runtime.html#alembic.runtime.environment.EnvironmentContext.configure.params.process_revision_directives">EnvironmentContext.configure.process_revision_directives</a></strong> 钩子而言，这里的行为是多次调用 <code>process_revision_directives</code> 钩子，每次调用 [context.run_migrations()] 一次。 这意味着如果要将 multi-run_migrations() 方法与 <code>process_revision_directives</code> 钩子结合使用，则必须注意适当地使用钩子。</p>
<p>首先要注意的是，当 <strong>第二次</strong> 调用 <code>run_migrations()</code> 时，<code>.upgrade_ops</code> 和 <code>.downgrade_ops</code> 属性被 <strong>转换为 Python 列表</strong>，并且新的 <strong><a href="../en/operations.html#alembic.operations.ops.UpgradeOps">UpgradeOps</a></strong> 和 <strong><a href="../en/operations.html#alembic.operations.ops.DowngradeOps">DowngradeOps</a></strong> 对象附加到这些列表中。 每个 <strong><a href="../en/operations.html#alembic.operations.ops.UpgradeOps">UpgradeOps</a></strong> 和 <strong><a href="../en/operations.html#alembic.operations.ops.DowngradeOps">DowngradeOps</a></strong> 对象分别维护一个 <code>.upgrade_token</code> 和一个 <code>.downgrade_token</code> 属性，用于将其内容渲染到适当的模板令牌中。</p>
<p>例如，引擎名称为 <code>engine1</code> 和 <code>engine2</code> 的多引擎运行将在运行时生成 <code>engine1_upgrades</code>、<code>engine1_downgrades</code>、<code>engine2_upgrades</code>和<code>engine2_downgrades</code>标记。 生成的迁移结构如下所示：</p>
<pre><code class="language-python">from alembic.operations import ops
import sqlalchemy as sa

migration_script = ops.MigrationScript(
    'eced083f5df',
    [
        ops.UpgradeOps(
            ops=[
                # upgrade operations for &quot;engine1&quot;
            ],
            upgrade_token=&quot;engine1_upgrades&quot;
        ),
        ops.UpgradeOps(
            ops=[
                # upgrade operations for &quot;engine2&quot;
            ],
            upgrade_token=&quot;engine2_upgrades&quot;
        ),
    ],
    [
        ops.DowngradeOps(
            ops=[
                # downgrade operations for &quot;engine1&quot;
            ],
            downgrade_token=&quot;engine1_downgrades&quot;
        ),
        ops.DowngradeOps(
            ops=[
                # downgrade operations for &quot;engine2&quot;
            ],
            downgrade_token=&quot;engine2_downgrades&quot;
        )
    ],
    message='migration message'
)
</code></pre>
<p>鉴于上述情况，当 <code>env.py</code> 脚本在运行自动生成时多次调用 <strong><a href="../en/runtime.html#alembic.runtime.migration.MigrationContext.run_migrations">MigrationContext.run_migrations()</a></strong> 时，应考虑以下准则：</p>
<ul>
<li>如果 <code>process_revision_directives</code> 钩子旨在<strong>根据当前数据库/连接的检查添加元素</strong>，它应该在每次迭代中执行其操作。 这样每次钩子运行时，数据库都是可用的。</li>
<li>或者，如果 <code>process_revision_directives</code> 钩子旨在<strong>修改适当的迁移指令列表</strong>，则应仅在最后一次迭代时调用。 这样一来，钩子每次都不会被赋予一个不断增长的结构，而它之前已经修改过。</li>
<li><strong><a href="#alembic.autogenerate.rewriter.Rewriter">Rewriter</a></strong> 对象，如果使用的话，应该在<strong>最后一次迭代</strong>时调用，因为它每次都会传递所有指令，所以再次避免双重/三重/等。 指令的处理只有在结构完成时才应该调用它。</li>
<li>在引用 <strong><a href="../en/operations.html#alembic.operations.ops.UpgradeOps">UpgradeOps</a></strong> 和 <strong><a href="../en/operations.html#alembic.operations.ops.DowngradeOps">DowngradeOps</a></strong> 对象的集合时，应参考 <strong><a href="../en/operations.html#alembic.operations.ops.MigrationScript.upgrade_ops_list">MigrationScript.upgrade_ops_list</a></strong> 和 <strong><a href="../en/operations.html#alembic.operations.ops.MigrationScript.downgrade_ops_list">MigrationScript.downgrade_ops_list</a></strong> 属性。</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                                                    <a rel="prev" href="../zh/08_06_01_getting_diffs.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        
                                                    <a rel="next" href="../zh/08_06_03_autogenerating_custom_operation_directives.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                                    <a rel="prev" href="../zh/08_06_01_getting_diffs.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                
                                    <a rel="next" href="../zh/08_06_03_autogenerating_custom_operation_directives.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                            </nav>

        </div>

                <!-- Livereload script (if served using the cli tool) -->
        <script type="text/javascript">
            var socket = new WebSocket("ws://localhost:3000/__livereload");
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>
        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        
    </body>
</html>
